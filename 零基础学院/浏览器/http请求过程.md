## 浏览器输入URL到发起http请求所经历的过程

### 在浏览器中输入 URL 时发生了什么

当你在浏览器的输入框中输入 **URL** 时，操作系统（**OS**）会将输入事件传递给浏览器中。在这个过程中，浏览器可能会做一些预处理，例如：chrome 可能会根据以往的历史记录来预估输入字符对应的网站。例如输入 goog ，根据历史记录90%的概率会访问「www.google.com 」域名地址，因此就在你按下回车键之前就开始建立 TCP 链接渲染了。

接着是输入**URL**之后，点击回车，这时浏览器会对 **URL** 进行检查，首先判断协议，如果是 http 就按照 Web 来处理，另外还会对这个 **URL** 进行安全检查。安全检查完成之后，在浏览器内核中会先查看缓存，然后设置 UA 等 HTTP 信息，接着调用不同平台下网络请求的方法。

**⚠️浏览器和浏览器内核是不同的概念，浏览器指的是 Chrome、Firefox，而浏览器内核则是 Blink、Gecko，浏览器内核只负责渲染，GUI 及网络连接等跨平台工作则是浏览器实现的**

***

### http网络请求

http网络请求的实际过程：
1. 通过 DNS 查询 IP；
2. 通过 Socket 发送数据；
3. dns查询ip；

***

### 是怎样通过 DNS 查询 IP 的？

    DNS，英文是 Domain Name System，中文叫域名系统，是Internet的一项服务，他将域名和IP地址相互映射的一个分布式数据库。

    应用程序（浏览器）将请求发送给 DNS ，以便将用户指定的域名转化成（解析）互联网络地址（这货其实就是 IP）

    进行 DNS 查询的主机或软件叫做 DNS 解析器，用户使用的工作站或电脑都属于解析器。域名解析就是利用 DNS 解析器得到对应 IP 过程，解析器会向域名服务器进行查询处理。

主要过程如下：

1. 从浏览器缓存中查找域名 www.google.com 的IP地址
2. 在浏览器缓存中没找到，就在操作系统缓存中查找，这一步中也会查找本机的 hosts 看看有没有对应的域名映射(当然已经缓存在系统 DNS 缓存中了)
3. 在系统中也没有的话，就到你的路由器来查找，因为路由器一般也会有自己的 DNS 缓存

如果以上都没有找到，则继续往下向dns域名服务器查询：
- 用户电脑的解析器向LDNS(也就是Local DNS，互联网服务提供商ISP)，发起域名解析请求，查询www.google.com的IP地址，这是一个递归查找过程
- 在缓存没有命中的情况下，LDNS向根域名服务器.查询www.google.com的IP地址，LDNS的查询过程是一个迭代查询的过程
- 根告诉LDNS，我不知道www.google.com对应的IP，但是我知道你可以问com域的授权服务器，这个域归他管
- LDNS向com的授权服务器问www.google.com对应的IP地址
- com告诉LDNS，我不知道www.google.com对应的IP，但是我知道你可以问google.com域的授权服务器，这个域归他管
- LDNS向google.com的授权服务器问www.google.com对应的IP地址
- google.com查询自己的ZONE文件(也称区域文件记录)，找到了www.google.com对应的IP地址，返回给LDNS
- LDNS本地缓存一份记录，把结果返回给用户电脑的解析器
- 在这之后，用户电脑的解析器拿到结果后，缓存在自己操作系统DNS缓存中，同时返回给浏览器，浏览器依旧会缓存一段时间。

**⚠️域名查询时有可能是经过了 CDN 调度器的(如果有cdn存储功能的话)，dns 解析是很耗时的，因此如果解析域名过多，会让首屏加载变得过慢，可以考虑 dns-prefetch 优化**

***

### tcp/ip请求

有了 IP 地址，就可以通过 Socket API 来发送数据了，这时可以选择 TCP 或 UDP 协议。http本质是tcp协议。

TCP是一种面向有连接的传输层协议。他可以保证两端(发送端和接收端)通信主机之间的通信可达。他能够处理在传输过程中丢包、传输顺序乱掉等异常情况;此外他还能有效利用宽带，缓解网络拥堵。

建立TCP连接一开始都要经过三次握手：

1. 客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；
2. 第二次握手：服务器收到syn包，必须确认客户的syn（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；
3. 第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态。

在TCP连接建立完成之后就可以发送HTTP请求了。

**浏览器对同一个域名有连接数限制，大部分是 6，http1.0中往往一个资源下载就需要对应一个tcp/ip请求，而像 HTTP 2.0 协议尽管只使用一个 TCP 连接来传输数据，但性能反而更好，而且还能实现请求优先级。**

***

### 延伸阅读

> 读完这篇还不尽兴？那读读这篇吧，[彻底弄懂HTTP缓存机制及原理](https://www.cnblogs.com/chenqf/p/6386163.html)

***

### 这里加一部分常用的 HTTP 状态码，就不单独写一份了

响应状态代码有三位数字组成，第一个数字定义了响应的类别，且有五种可能取值。

**常见状态码：**
- 100~199：表示服务器成功接收部分请求，要求客户端继续提交其余请求才能完成整个处理过程。

- 200~299：表示服务器成功接收请求并已完成整个处理过程。常用200（OK 请求成功）。

- 300~399：为完成请求，客户需进一步细化请求。例如：请求的资源已经移动一个新地址、常用302（所请求的页面已经临时转移至新的url）、307和304（使用缓存资源）。

- 400~499：客户端的请求有错误，常用404（服务器无法找到被请求的页面）、403（服务器拒绝访问，权限不够）。

- 500~599：服务器端出现错误，常用500（请求未完成。服务器遇到不可预知的情况）。

**所有响应状态码：**

> **1xx:信息**

|码|状态|
|------|------|
| **100** *Continue* | 服务器仅接收到部分请求，但是一旦服务器并没有拒绝该请求，客户端应该继续发送其余的请求。 |
| **101** *Switching Protocols* | 服务器转换协议：服务器将遵从客户的请求转换到另外一种协议。 |

> **2xx:成功**

| 码 | 状态 |
|------|------|
| **✅200** *OK* | **请求成功**（其后是对GET和POST请求的应答文档）。*比如GET请求，请求的资源会作为响应实体返回；而HEAD请求，信息只存在于响应报文首部，因为它不会返回报文实体，只返回报文首部*  |
| **201** *Created* | 请求被创建完成，同时新的资源被创建。 |
| **202** *Accepted* | 供处理的请求已被接受，但是处理未完成。 |
| **203** *Non-authoritative Information* | 文档已经正常地返回，但一些应答头可能不正确，因为使用的是文档的拷贝。 |
| **✅204** *No Content* | **表示请求已成功处理，但是没有内容返回**（就应该没有内容返回的状况）。也就是返回的响应报文中没有报文实体（其实是没有报文实体的主体部分）*浏览器向服务器发送请求后收到了204，那么浏览器页面不会发生更新。一般用在只是客户端向服务器发送信息，而服务器不用向客户端返回什么信息的情况* |
| **205** *Reset Content* | 没有新文档。但浏览器应该重置它所显示的内容。用来强制浏览器清除表单输入内容。 |
| **✅206** *Partial Content* | **客户发送了一个带有Range头的GET请求，服务器完成了它**。（客户端进行了范围请求）*响应报文中包含Content-Range指定范围的实体内容* |

> **3xx:重定向**

| 码 | 状态 |
|------|------|
| **300** *Multiple Choices* | 多重选择。链接列表。用户可以选择某链接到达目的地。最多允许五个地址。 |
| **✅301** *Moved Permanently* | **永久重定向，表示请求的资源已经永久的搬到了其他位置** *就是说资源已经被分配了新的URI，新的URI应该提示在响应报文的Location首部字段，只要不是HEAD请求，响应实体应该包含新URI的超链接和简短的说明*  |
| **✅302** *Moved Temporarily* | **临时重定向，表示请求的资源临时搬到了其他位置** |
| **✅303** *See Other* | **表示请求资源存在另一个URI，应使用GET定向获取请求资源**。303功能与302一样，区别只是303明确客户端应该使用GET访问。*很多HTTP/1.1之前的浏览器不能理解303，但是大家都把302当303对待，使用GET请求新URI* |
| **✅304** *Not Modified* | **表示客户端发送附带条件的请求（GET方法请求报文中的IF…）时，条件不满足** 返回304时，不包含任何响应主体。*虽然304被划分在3XX，但和重定向一毛钱关系都没有* |
| **305** *Use Proxy* | 客户请求的文档应该通过Location头所指明的代理服务器提取。 |
| **306** *Unused* | 此代码被用于前一版本。目前已不再使用，但是代码依然被保留。 |
| **✅307** *Temporary Redirect* | **临时重定向**，和302有着相同含义。*尽管302标准禁止POST变为GET，但没人听他的，而307就会遵照标准，不会从POST变为GET，但处理响应行为，各个浏览器可能不同。*  |

> 4xx:客户端错误

| 码 | 状态 |
|------|------|
| **✅400** *Bad Request* | **表示请求报文存在语法错误或参数错误，服务器不理解** 服务器不应该重复提交这个请求，需要修改请求内容后再次发送。 |
| **✅401** *Unauthorized* | **表示发送的请求需要有HTTP认证信息或者是认证失败了** 返回401的响应必须包含一个适用于被请求资源的WWW-Authenticate首部以质询用户信息，浏览器初次接受401时，会弹出认证窗口 |
| **401.1** | 登录失败。 |
| **401.2** | 服务器配置导致登录失败。 |
| **401.3** | 由于 ACL 对资源的限制而未获得授权。 |
| **401.4** | 筛选器授权失败。 |
| **401.5** | ISAPI/CGI 应用程序授权失败。 |
| **401.7** | 访问被 Web 服务器上的 URL 授权策略拒绝。这个错误代码为 IIS 6.0 所专用。 |
| **402** *Payment Required* | 此代码尚无法使用。 |
| **✅403** *Forbidden* | **表示对请求资源的访问被服务器拒绝了** 服务器可以对此作出解释，也可以不解释，想说明的话可以在响应实体的主体部分描述原因。*比如说你可能没有访问权限* |
| **403.1** | 执行访问被禁止。 |
| **403.2** | 读访问被禁止。 |
| **403.3** | 写访问被禁止。 |
| **403.4** | 要求 SSL。 |
| **403.5** | 要求 SSL 128。 |
| **403.6** | IP 地址被拒绝。 |
| **403.7** | 要求客户端证书。 |
| **403.8** | 站点访问被拒绝。 |
| **403.9** | 用户数过多。 |
| **403.10** | 配置无效。 |
| **403.11** | 密码更改。 |
| **403.12** | 拒绝访问映射表。 |
| **403.13** | 客户端证书被吊销。 |
| **403.14** | 拒绝目录列表。 |
| **403.15** | 超出客户端访问许可。 |
| **403.16** | 客户端证书不受信任或无效。 |
| **403.17** | 客户端证书已过期或尚未生效。 |
| **403.18** | 在当前的应用程序池中不能执行所请求的 URL。这个错误代码为 IIS 6.0 所专用。 |
| **403.19** | 不能为这个应用程序池中的客户端执行 CGI。这个错误代码为 IIS 6.0 所专用。 |
| **403.20** | Passport 登录失败。这个错误代码为 IIS 6.0 所专用。 |
| **✅404** *Not Found* | **表示服务器找不到你请求的资源** 也有可能服务器就是不想给你然后骗你找不到(⊙ˍ⊙) ，而且大多服务器都是这么玩这个状态码的 |
| **404.0** | 没有找到文件或目录。 |
| **404.1** | 无法在所请求的端口上访问 Web 站点。 |
| **404.2** | Web 服务扩展锁定策略阻止本请求。 |
| **404.3** | MIME 映射策略阻止本请求。 |
| **405** *Method Not Allowed* | 请求中指定的方法不被允许。 |
| **406** *Not Acceptable* | 服务器生成的响应无法被客户端所接受。 |
| **407** *Proxy Authentication Required* | 用户必须首先使用代理服务器进行验证，这样请求才会被处理。 |
| **408** *Request Timeout* | 请求超出了服务器的等待时间。 |
| **409** *Conflict* | 由于冲突，请求无法被完成。 |
| **410** *Gone* | 被请求的页面不可用。 |
| **411** *Length Required* | "Content-Length" 未被定义。如果无此内容，服务器不会接受请求。 |
| **412** *Precondition Failed* | 请求中的前提条件被服务器评估为失败。 |
| **413** *Request Entity Too Large* | 由于所请求的实体的太大，服务器不会接受请求。 |
| **414** *Request-url Too Long* | 由于url太长，服务器不会接受请求。当post请求被转换为带有很长的查询信息的get请求时，就会发生这种情况。 |
| **415** *Unsupported Media Type* | 由于媒介类型不被支持，服务器不会接受请求。 |
| **416** *Requested Range Not Satisfiable* | 服务器不能满足客户在请求中指定的Range头。 |
| **417** *Expectation Failed* | 执行失败。 |
| **423** | 锁定的错误。 |

> **5xx:服务器错误**

| 码 | 状态 |
|------|------|
| **✅500** *Internal Server Error* | **表示服务器执行请求的时候出错了** 可能是Web应用有bug或临时故障，更有可能是服务器源代码有bug… |
| **500.12** | 应用程序正忙于在 Web 服务器上重新启动。 |
| **500.13** | Web 服务器太忙。 |
| **500.15** | 不允许直接请求 Global.asa。 |
| **500.16** | UNC 授权凭据不正确。这个错误代码为 IIS 6.0 所专用。 |
| **500.18** | URL 授权存储不能打开。这个错误代码为 IIS 6.0 所专用。 |
| **500.100** | 内部 ASP 错误。 |
| **501** *Not Implemented* | 请求未完成。服务器不支持所请求的功能。 |
| **502** *Bad Gateway* | 请求未完成。服务器从上游服务器收到一个无效的响应。 |
| **502.1** | CGI 应用程序超时。 |
| **502.2** | CGI 应用程序出错。 |
| **✅503** *Service Unavailable* | **表示服务器超负载或正停机维护，无法处理请求** 如果服务器知道还需要多长时间，就写入Retry-After首部字段返回 |
| **504** *Gateway Timeout* | 网关超时。 |
| **505** *HTTP Version Not Supported* | 服务器不支持请求中指明的HTTP协议版本 |

✅表示服务器返回的14种状态码