## TCP 和 UDP 知多少

这两天正在看 **《分布式系统概念以设计》** 这本书，刚好看到 **TCP** 和 **UDP** 这里，就想整理一波知识点，以便今后学习参考。

***

### 属于OSI协议的传输层

**TCP** 和 **UDP** 是在 **OSI协议** （共有7层）的传输层。这层主要是处理消息的最低的一层。消息被定位到与进程相连的通信端口上。这层协议可以是面向连接的，也可以是无连接的。

这一层主要负责：
- **数据包组装**：在传输前将消息分割成多个数据包，并在接收端重新组装各个数据包。
- **消息传送服务**：在一对网络端口间提供提供与网络无关的消息传送服务。
- **寻址**：负责将消息传送到目的地址，其实用的网络传输地址由主机的网络地址和一个端口号组成。

***

### TCP

#### TCP/IP

**TCP** 一般是以 **TCP/IP** (协议组)的形式出现的。

其中， **TCP** 指的是传输控制协议，**IP** 指的是网际协议。

    现在许多应用服务和应用层的协议都是基于 TCP/IP：
    - Web（HTTP）
    - 电子邮件（SMTP、POP）
    - 网络新闻（NNTP）
    - 文件传输（FTP）
    - 远程登陆（telnet）

**TCP** 通过基于流的编程抽象，提供了任一长度字节串的可靠传输。

#### TCP的特点


    - 面向连接：在数据被传送前，发送进程和接收进程会先建立一个双向通信通道。使用三次握手协议建立连接。

    - 消息大小：TCP 流的底层实现了决定在将数据分割为IP数据包发送之前要搜集多少数据量。

    - 排序：TCP 的发送进程将数据流分割成有序号的数据片断，之后作为 IP 数据包传送。接收程序则将数据片断按序号排列。编号小的排好放入流中后，编号大的才会放入流中。未排到的会暂时保存到一个缓存区中。

    - 流控制：通过片断确认机制可以保证发送方或者中间节点不会过载。TCP 流试图匹配读写流的进程速度。若过快，读写速度会被阻塞，直到读取流消化掉足够的数据为止。

    - 重传：发送方会记录发送片断的序号，若在指定的超时时间里收到了来自接收方的确认信息，则会在缓冲区将该片断清除，若没有收到，则会重发一份该片断。

    - 缓冲：接收方的缓冲区用于平衡发送方和接收方之间的流量。如果缓冲区溢出，则接收方不会给发送方信息确认，所以发送方要被迫重传片断。

    - 校验和：每个片断包含一个对头部和片断数据的校验和，如果接受到的片断与校验和不匹配，则丢弃。

    - 可以直接支持应用程序，也可以将附加协议在它上面：通常，**HTTP** 传输时直接使用 **TCP**，但当需要端 - 端的安全性时，传输层安全（TLS）协议就会放在 **TCP** 的上层，以建立安全信道，**HTTP** 消息通过这一安全信道进行传输。


#### TCP 的使用

**TCP** 协议 API 提供了可读写的字节流。

下面这些服务在 **TCP** 上运行
- **HTTP**：超文本传输协议用于 Web 浏览器和 Web 服务器之间的通信。
- **FTP**：文件传输协议允许浏览远程计算机上的目录，以及通过链接将文件从一台计算机传送到另一台计算机。
- **telnet**：利用终端会话访问计算机。
- **SMTP**：简单邮件传输协议用于在计算机之间发送邮件。


#### 故障模型

- 完整性：TCP 流使用校验和检查并丢弃损坏的数据包，使用序列号检查和丢弃重复的数据包。
- 有效性：TCP 流使用超时和重传来处理丢失的数据包。

因此即使有底层的数据包丢失，也可以保证消息的传输。

但是如果连接上的数据包丢失超过一定限制以及连接一对通信进程的网络不稳定或严重阻塞，会导致 TCP 的发送方接受不到确认消息，这种状况持续一段时间后，TCP会声明连接中断。

中断后若还有进程试图进行读写操作，则该进程：
- 不能区分该故障是网络故障还是连接另一端的进程故障。
- 不能区分最近发送的消息是否已被接收。

***

### UDP

**UDP** 基本是 IP 在传输层的一个复制。

**UDP** 数据报被封装在一个 IP 数据包中。

**UDP** 的头部包含源端口号和目的地端口号

**UDP** 有一个长度域。

**UDP** 一个校验和。

**UDP** 不提供传输保证。（从数据报的发送到接收，不需要确认和重传）

**UDP** 传输最长为 64KB。

#### UDP 特点：

    - 消息大小：接收程序要指定固定大小的字节数组，消息大于数组大小将被拦截。底层 IP 协议允许数据报最大为 216 字节（包括消息头和消息本身）。但大多数环境下消息本限制在 8 KB左右。

    - 阻塞：套接字通常提供非阻塞的 send 操作和阻塞的 receive 操作进行数据报的通信。

    - 超时：在套接字上设置超时可以避免 receive 由于发送进程崩溃或者丢失数据包而无限等待。

    - 任意接收：receive 方法不指定消息来源，它会返回发送方的互联网地址和本地端口号，允许发送方检查消息来源。


#### 故障模型

- 故障遗漏：消息偶尔都是，可能是因为校验和失败或者是在发送端或目的地端没有可用的缓冲空间造成的。发送遗漏故障和接收遗漏故障统称为通信通道中的遗漏故障。

- 排序：消息有时没有按发送方顺序发送。UDP 需要手动检查数据包的应用。

#### UDP 的使用

以下都是在 UDP 上运行的：
- **域名服务**
- **VOIP**（*Voice Over IP*）

开销来源：

1. 需要时源和目的地存储状态信息
2. 传输额外的消息
3. 发送方的延迟

***

### TCP 和 UDP 的区别

**从消息的传递方式上**：

    - TCP 的应用程序接口提供了进程之间的 双向流 抽象；
    - UDP 的应用程序接口提供了 消息传递 抽象。

**从可靠性上**：

    - TCP 提供消息确认机制，使用重传和缓存来确保消息传递的完整性；
    - UDP 没有消息确认机制，不会重传。

**从排序上**：

    - TCP 的接收程序会根据 IP 数据包的序号进行排序接收；
    - UDP 消息发送没有排序，需要手动检查。

**从消息大小上**：

    - TCP 把数据流分割成适当长度的 IP 数据包，最大传输段大小（MSS）通常受该计算机连接的网络的数据链路层的最大传送单元（MTU）限制；
    - UDP 数据报大小由接收程序要指定固定大小的字节数组。

... 
***

### 窗口大小

    普及个知识点：源主机在收到确认消息之前可以传输的数据的大小称为窗口大小。用于管理丢失数据和流量控制